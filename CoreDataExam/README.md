# 코어 데이터(CoreData)


코어 데이터는 애플이 코코아 개발 환경을 통해 제공하는 **인메모리(In-Memory)** 방식의 데이터 관리 프레임워크이다.
코어데이터를 사용하여 예의 데이터베이스 개발 환경과 유사하게 데이터를 읽고 쓰며 수정하고 삭제할 수 있다.

인메모리 방식인 만큼, 코어 데이터에서 데이터를 다루는 모든 작업은 메모리를 기반으로 동작한다. 즉 코어 데이터를 통해 읽고 쓰는 모든 데이터는 원칙적으로 메모리에 로드된 다음에 처리된다. 메모리에 로드되기 때문에 대량의 읽기와 쓰기 작업에 의한 성능저하에 크게 영향을 끼치지 않는다. 대부분의 작업이 영구 저장소(Persistence Storage)에서 직접 처리되고, 효율성을 위해 읽기 목적의 데이터 일부만 메모리에 올려 놓고 사용하는 데이터베이스와는 구분되는 효율적 특성이다.
인메모리방식임에 불구하고 앱이 종료가 되어도 코어데이터 내부적으로는 파일이나 SQLite 같은 영구 저장소에 보조적으로 데이터를 저장할 수 있기 때문에 데이터가 삭제가 되지않는다.

## 코어 데이터 vs SQLite


|SQLite|<----->|Core Data|
|:---|:---|:---|
|데이터베이스 파일|<----->|데이터 모델 파일|
|테이블|<----->|엔터티|
|컬럼|<----->|어트리뷰트|
|왜래키+조인|<----->|릴레이션|


코어데이터가 사용하는 데이터 저장구조는 SQLite 와 상당히 유사하다. 
코어데이터는 데이터베이스 처럼 구조화된 데이터를 영구 저장소에 저장하고, 이를 검색하거나 정렬할 수 있는 수단을 제공한다. 게대가 데이터를 정규화할 수 있으며, 빠른 검색을 위해 인덱스를 생성할 수도 있다. 

> 코어데이터는 데이터베이스? SQLite의 래퍼클래스?

결론부터 말하면 코어데이터는 데이터베이스로 보면 안된다. 코어데이터는 영구 저장소로 SQLite 대신 바이너리 파일을 사용할 수 있을 뿐만 아니라 영구 저장소를 아예 사용하지 않고 순수하게 인메모리 방식으로 만 사용하는 것도 가능하기 때문에 데이터베이스의 한 종류 혹은 SQLite의 래퍼라고 말하는 것은 어렵다.

코어데이터를 다룰때 사용하는 코드 형식은 [DAO 패턴](https://github.com/gaki2745/Youngjun-iOS-Studio/tree/master/DAOPatternExam) 스타일과 매우 유사하다. SQL 문을 포함한 DB 처리 코드를 모두 DAO 클래스 내부에 숨기고 뷰 컨트롤러에서는 DAO 클래스의 메소드만 호출하는 방식으로 사용했던 것 처럼, 코어 데이터에서도 뷰컨트롤러는 단지 **관리 객체 컨텍스트(Managed Object Context)** 객체를 통해 필요한 메소드만 호출하면된다. 관리 객체 컨텍스트는 코어 데이터에서 만들어 제공해 주기 떄문에 직접 정의할 필요가 없는 것이 DAO 패턴과 차이점이다.

코어 데이터에서는 각각의 레코드를 **관리 객체(Managed Object)** 라고 하는데, 이 관리 객체는 [VO패턴](https://genesis8.tistory.com/214) 유사한 형태로 정의된 클래스 인스턴스에 할당된 상태로 사용된다. 이를 **MO 패턴**이라고 한다.
MO 클래스의 프로퍼티를 엔터티의 각 어트리뷰트와 직접 연결 시키는 방식을 사용하는데 이 방식을 [ORM 매핑](https://jayzzz.tistory.com/66)이라고 한다.


> ORM 매핑
"Object - Relational Mapping" 데이터베이스와 객체 지향 프로그래밍 언어 사이의 비호환 데이터를 반환하는 프로그래밍 기법


## 코어 데이터에 대한 이해


### 객체 그래프 관리자(Object Graph Manager)

애플 공식문서에 따르면 코어 데이터는 **"애플리케이션에서 모델(Model) 계층의 객체를 관리하는 데 사용하는 프레임워크이자, 라이프 사이클이나 영속성 관리를 위한 기능을 제공하는 객체 그래프 관리자(Object Graph Manager"** 로 정의된다.


#### 객체 그래프(Object Graph)란?

코어 데이터는 영구 저장소에 저장된 각각의 레코드를 읽어들인 다음, 독립적인 객체 형태로 만들어 낸다. 데이터를 다루는 행위는 코어 데이터에서 모두 **객체 단위**로 이루어진다.
이때 레코드의 데이터가 객체화된 것을 가리켜 '관리되는 객체(Managed Object)', 또는 '관리객체'라고 부른다.


정규화된 데이터 객체는 다른 객체와 참조 관계 하에 있으며, 서로간의 관계를 통해 데이터의 완전성을 보장받을 수 있다. 이때 객체를 하나의 노드로 간주하고, 서로 간의 연관 관계를 릴크로 이어보면 다양하게 연결되는 복합적인 그래프 형태의 도형을 얻게 되는데, 이것이 바로 객체 그래프이다.

![image](https://user-images.githubusercontent.com/33486820/54890932-edc7fb80-4eee-11e9-8b8b-9936325d75a3.png)

코어 데이터가 객체 그래프의 관리를 담당하는 것은, **객체 A를 객체 B와 연결할 수 있으며 이 연결을 통해 A와 B는 영속적으로 동기화 된다** 는 것을 뜻한다. 객체 A 에서 업데이트가 발생하면 이에 연결된 객체 B에서도 연간된 데이터의 업데이트가 수행된다. 또한 한쪽에서 객체를 삭제하면 연결을 타고 연이어 객체 객체 B에서도 관련된 데이터의 삭제가 발생하도록 처리가 가능하다.


코어데이터는 전체적으로는 데이터베이스와 비슷한 기능을 제공하지만, 엄밀하게 말해 데이터 저에 관련된 기능을 제공하는 프레임워크라고 할 수 있다. 또한 데이터를 객체로 다루며, 정규화된 데이터 사이의 참조 관계를 바탕으로 한쪽 객체에서 발생한 변경 내용을 다른 쪽 객체에서도 전파하는 등 객체 간 관계의 일관성을 유지하는 객체 그래프 관리자로서의 특징을 가진다.



## 코어 데이터의 구조


코어 데이터는 다층 구조로 이루어진 프레임워크로, 각 층을 담당하는 핵심 객체들이 서로 밀접한 연관성을 가진 채 상호작용한다. 전체적으로 코어 데이터는 개발자와 영구 저장소 사이를 이어주는 프레임워크이기 때문에 FMDB 라이브러리와도 일맥 상통하는 브븐이 많다.


### 관리 객체(Managed Object)


관리 객체는 코어 데이터에서 데이터를 저장하기 위해 생성하는 인스턴스이다. 관계형 데이터베이스에서 테이블의 행이나 레코드와 유사하다 코어 데이터는 모든 레코드를 객체화하여 다루기 때문에, 독립된 객체로 동작한다. 이때, 레코드를 구성하는 각 칼럼들은 관리 객체의 속성이 된다.

레코드 두개를 읽기 위해서는 두개츼 관리 객체가 필요하고, 새로운 레코드를 추가할 때 역시 데이터를 담을 관리 객체가 생성되어야 한다. 코어 데이터에서 사용되는 관리객체는 모두 **NSManagedObject 클래스**나 또는 그 하위 클래스의 인스턴스 이며, 생성된 관리 객체들은 모두 관리 객체 컨텍스트에 담겨 관리된다.


### 관리 객체 컨텍스트(Managed Object Context)


관리 객체 컨텍스트는 코어 데이터에서 가장 핵심적인 객체로, 크게 두가지 역할을 담당한다

1. 관리 객체를 담거나 생성, 삭제할 수 있다. 모든 관리 객체는 컨텍스트에 담겨 관리되는데 데이터를 읽거나 쓰고, 수정하는 작업은 모두 컨텍스트를 통해 처리된다. 코어 데이터가 다루는 모든 데이터는 메모리에 로드된 상태로 처리되는데 이떄의 메모리는 곧 컨텍스트를 의미한다.

2. 영구 저장소 및 저장소 코디네이터에 대한 관리자이다. 컨텍스트는 영구 저장소 코디네이터와 매우 밀접하게 연결되어 있으며, 읽기 및 쓰기 요청을 처리한다. 하지만 이 작업은 모두 컨텍스트 내부에서 처리하기 때문에, 특정 메소드를 호출하는 것만으로 데이터를 읽거나 쓰는 데 필요한 모든 작업을 처리할 수 있다

### 영구 저장소 코디네이터(Persistent Store Coordinator)

영구 저장소 코디네이터는 컨텍스트와 직접 데이면서 다양한 영구 저장소들의 접근을 조정하고, 해당 저장소에 대한 실제 입출력을 담당한다.

코디네이터는 단일 컨텍스트와 연결되어 애플리케이션이 전달하는 각종 요청을 처리하는데, 예를들어 필요한 객체가 아직 컨텍스트에 로딩 되지 않았다면 코딩네이터는 캔텍스트로부터 요청을 받아 영구저장소에 데이터를 찾고, 이를 컨텍스트에 전달하여 메모리에 로드 하는 방식이다. 이 과정에서 코디네이터는 미리 정의된 관리 객체 모델을 사용하여 인스턴스를 생성하고 여기에 읽어온 데이터를 담아 전달하고, 이렇게 생성된 인스턴사 바로 관리 객체이다.
이 과정은 컨텍스트 객체와 영구 저장소 사이에서 자동으로 처리되기 때문에 개발자가 직접 코디네이터에 접속하여 뭔가를 처리해야하는 경우는 거의 없다.








